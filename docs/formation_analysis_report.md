# Formation Analysis Report

## 1. Introduction
This report addresses concerns regarding the realism of the simulated triangular satellite formation, specifically the "too precise" side lengths in `triangle_geometry.csv` and perceived inconsistencies in plots like `formation_triangle_snapshot.svg`, `ground_tracks_tehran.svg`, and `relative_positions.svg`.

## 2. Analysis of `triangle_geometry.csv`
The `triangle_geometry.csv` file, generated by `sim/formation/triangle_artefacts.py` based on data from `sim/formation/triangle.py`, consistently shows side lengths very close to 6 km and an aspect ratio near 1.0. This indicates an almost perfect equilateral triangle.

## 3. Investigation of Simulation Core (`sim/formation/triangle.py`)
The `simulate_triangle_formation` function in `sim/formation/triangle.py` is responsible for propagating satellite orbits. It utilizes the `propagate_perturbed` function from `src/constellation/orbit.py` for this purpose.

### 3.1 Perturbation Modeling in `src/constellation/orbit.py`
A detailed review of `src/constellation/orbit.py` confirms that the `propagate_perturbed` function explicitly includes:
*   **J2 Perturbation:** Calculated using the standard J2 coefficient (`J2_TERM = 0.00108262668`).
*   **Atmospheric Drag:** Modeled using a simplified exponential atmospheric density model, taking into account the `ballistic_coefficient`.
*   **Solar Radiation Pressure (SRP):** Included with parameters like `C_R` (reflectivity coefficient), `A_srp` (SRP area), and `m` (mass), although the sun direction is simplified to be along the x-axis.
*   **Numerical Integration:** A 4th-order Runge-Kutta (`rk4_step`) method is used for numerical integration, which is an appropriate method for perturbed orbital propagation.

This confirms that the simulation *does* account for key orbital perturbations.

## 4. Root Cause of "Unrealistic" Precision
The primary reason for the observed "too perfect" triangular formation, despite the inclusion of perturbation models, is the **short simulation duration**. The default simulation time for the "Tehran Triangle" scenario is 180 seconds. Over such a brief period, the cumulative effects of J2, atmospheric drag, and solar radiation pressure on the relative positions of the satellites are minimal. Consequently, the formation maintains its initial, near-ideal equilateral geometry with very little deviation, as reflected in `triangle_geometry.csv` and `formation_triangle_snapshot.svg`.

The initial setup of the formation also contributes to this. The satellites are initialized to form a perfect equilateral triangle in the Local Vertical Local Horizontal (LVLH) frame, and their relative velocities are set to zero. While this is a common starting point for formation flying analysis, it means that any observed deviation must accumulate from differential perturbations.

## 5. Inconsistencies in Plots
The perceived inconsistencies between `formation_triangle_snapshot.svg`, `ground_tracks_tehran.svg`, and `relative_positions.svg` are also a direct consequence of the short simulation duration and the resulting stability of the formation. If the satellites maintain a nearly ideal triangular formation throughout the 180-second window, all plots will consistently reflect this stable behavior. There is no inherent contradiction in the plots themselves; rather, the expectation of significant dynamic behavior is not met due to the limited simulation time.

## 6. Recommendation
To observe and accurately represent the dynamic effects of orbital perturbations on the triangular formation, the simulation duration needs to be significantly extended. A longer simulation period (e.g., several orbital periods, or even days) would allow the cumulative effects of J2, drag, and SRP to become more pronounced, leading to a more realistic and dynamic evolution of the formation geometry. This would provide a clearer picture of how the formation drifts and deforms under natural forces, and would better align with the user's expectations of a non-idealized simulation.

## 7. Conclusion
The simulation correctly models orbital perturbations. The "unrealistic" precision of the triangular formation is an artifact of the short simulation duration. Increasing the simulation time is necessary to observe the expected dynamic behavior and validate the perturbation models more thoroughly.
